<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Dashboard Executive - NeoImpact Animation</title>
    <link rel="stylesheet" href="/static/css/neoimpact-ui.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">

<!-- Header -->
<header class="bg-gradient-to-r from-cyan-600 to-teal-600 text-white shadow-lg" style="background: linear-gradient(135deg, #00A5A8 0%, #008B8E 100%);">
    <div class="container mx-auto px-6 py-4">
        <div class="flex justify-between items-center">
            <!-- Logo NeoImpact -->
            <div class="flex items-center gap-6">
                <div class="neoimpact-logo">
                    <div class="neoimpact-logo-icon" style="width: 56px; height: 56px;"></div>
                    <div class="neoimpact-logo-text">
                        <div class="neoimpact-logo-text-arabic" style="color: white;">ŸàŸÅÿßÿ≥ŸÑŸÅ</div>
                        <div class="neoimpact-logo-text-latin" style="color: #FFD600;">NeoImpact</div>
                    </div>
                </div>
                <div style="border-left: 2px solid rgba(255,255,255,0.3); height: 50px;"></div>
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-chart-line"></i>
                        Dashboard Executive
                    </h1>
                    <p class="text-sm" style="color: rgba(255,255,255,0.9);">Vue 360¬∞ Performance R√©seau National</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-sm text-purple-200">Derni√®re mise √† jour</p>
                    <p class="text-lg font-semibold" id="lastUpdate">Chargement...</p>
                </div>
                <button onclick="refreshData()" class="neoimpact-btn neoimpact-btn-primary flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    Actualiser
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="container mx-auto px-6 py-8">
    
    <!-- KPIs en temps r√©el -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- KPI: Animateurs Actifs -->
        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
            <div class="flex justify-between items-start mb-4">
                <div class="bg-blue-100 p-3 rounded-lg">
                    <i class="fas fa-users text-blue-600 text-2xl"></i>
                </div>
                <span class="text-green-500 text-sm font-semibold flex items-center gap-1">
                    <i class="fas fa-arrow-up"></i>
                    <span id="animatorsGrowth">--</span>
                </span>
            </div>
            <h3 class="text-gray-500 text-sm font-medium mb-1">Animateurs Actifs</h3>
            <p class="text-3xl font-bold text-gray-800" id="activeAnimators">--</p>
            <p class="text-gray-400 text-xs mt-2">sur <span id="totalAnimators">--</span> total</p>
        </div>

        <!-- KPI: Visites Mois -->
        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
            <div class="flex justify-between items-start mb-4">
                <div class="bg-green-100 p-3 rounded-lg">
                    <i class="fas fa-map-marker-alt text-green-600 text-2xl"></i>
                </div>
                <span class="text-green-500 text-sm font-semibold flex items-center gap-1">
                    <i class="fas fa-arrow-up"></i>
                    <span id="visitsGrowth">--</span>
                </span>
            </div>
            <h3 class="text-gray-500 text-sm font-medium mb-1">Visites Ce Mois</h3>
            <p class="text-3xl font-bold text-gray-800" id="totalVisits">--</p>
            <p class="text-gray-400 text-xs mt-2">Moyenne: <span id="avgVisitsPerAnimator">--</span> / animateur</p>
        </div>

        <!-- KPI: Revenus Mois -->
        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
            <div class="flex justify-between items-start mb-4">
                <div class="bg-yellow-100 p-3 rounded-lg">
                    <i class="fas fa-coins text-yellow-600 text-2xl"></i>
                </div>
                <span class="text-green-500 text-sm font-semibold flex items-center gap-1">
                    <i class="fas fa-arrow-up"></i>
                    <span id="revenueGrowth">--</span>
                </span>
            </div>
            <h3 class="text-gray-500 text-sm font-medium mb-1">Revenus Mois</h3>
            <p class="text-3xl font-bold text-gray-800" id="totalRevenue">--</p>
            <p class="text-gray-400 text-xs mt-2">Objectif: <span id="revenueTarget">--</span></p>
        </div>

        <!-- KPI: Taux Conversion -->
        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
            <div class="flex justify-between items-start mb-4">
                <div class="bg-purple-100 p-3 rounded-lg">
                    <i class="fas fa-percentage text-purple-600 text-2xl"></i>
                </div>
                <span class="text-green-500 text-sm font-semibold flex items-center gap-1">
                    <i class="fas fa-arrow-up"></i>
                    <span id="conversionGrowth">--</span>
                </span>
            </div>
            <h3 class="text-gray-500 text-sm font-medium mb-1">Taux Conversion</h3>
            <p class="text-3xl font-bold text-gray-800" id="conversionRate">--%</p>
            <p class="text-gray-400 text-xs mt-2">Leads qualifi√©s: <span id="qualifiedLeads">--</span></p>
        </div>

    </section>

    <!-- Charts Row 1 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- Chart: Revenue Forecast -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-line text-blue-600"></i>
                    Pr√©visions Revenus (30 jours)
                </h3>
                <div class="flex gap-2">
                    <button onclick="updateForecast(30)" class="px-3 py-1 rounded bg-blue-100 text-blue-600 text-sm hover:bg-blue-200">30j</button>
                    <button onclick="updateForecast(60)" class="px-3 py-1 rounded bg-gray-100 text-gray-600 text-sm hover:bg-gray-200">60j</button>
                    <button onclick="updateForecast(90)" class="px-3 py-1 rounded bg-gray-100 text-gray-600 text-sm hover:bg-gray-200">90j</button>
                </div>
            </div>
            <canvas id="revenueForecastChart" height="250"></canvas>
        </div>

        <!-- Chart: Conversion Funnel -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-filter text-purple-600"></i>
                Funnel de Conversion
            </h3>
            <canvas id="conversionFunnelChart" height="250"></canvas>
        </div>

    </section>

    <!-- Charts Row 2 -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
        <!-- Chart: Regional Performance -->
        <div class="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-map text-green-600"></i>
                Performance R√©gionale
            </h3>
            <canvas id="regionalPerformanceChart" height="200"></canvas>
        </div>

        <!-- Top Performers -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-trophy text-yellow-600"></i>
                Top 5 Performers
            </h3>
            <div id="topPerformers" class="space-y-3">
                <!-- Chargement dynamique -->
            </div>
        </div>

    </section>

    <!-- Alertes Strat√©giques -->
    <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fas fa-exclamation-triangle text-red-600"></i>
            Alertes Strat√©giques
        </h3>
        <div id="strategicAlerts" class="space-y-3">
            <!-- Chargement dynamique -->
        </div>
    </section>

</main>

<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================
let charts = {};
const API_BASE_URL = '/api/analytics';

// ============================================================================
// INIT
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    loadDashboardData();
    
    // Auto-refresh every 2 minutes
    setInterval(loadDashboardData, 120000);
});

// ============================================================================
// LOAD DASHBOARD DATA
// ============================================================================
async function loadDashboardData() {
    try {
        // 1. Load Executive Overview
        const overview = await axios.get(`${API_BASE_URL}/executive/overview`);
        updateKPIs(overview.data.data);
        
        // 2. Load Revenue Forecast
        const forecast = await axios.get(`${API_BASE_URL}/executive/revenue-forecast?horizon=30`);
        updateRevenueForecastChart(forecast.data);
        
        // 3. Load Conversion Funnel
        const funnel = await axios.get(`${API_BASE_URL}/executive/conversion-funnel`);
        updateConversionFunnelChart(funnel.data.funnel);
        
        // 4. Load Regional Comparison
        const regions = await axios.get(`${API_BASE_URL}/executive/regional-comparison`);
        updateRegionalPerformanceChart(regions.data.regions);
        updateTopPerformers(regions.data.regions);
        
        // 5. Load Alerts
        const alerts = await axios.get(`${API_BASE_URL}/alerts?severity=critical`);
        updateStrategicAlerts(alerts.data.alerts);
        
        // Update timestamp
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
        
    } catch (error) {
        console.error('Erreur chargement dashboard:', error);
    }
}

// ============================================================================
// UPDATE KPIs
// ============================================================================
function updateKPIs(overview) {
    document.getElementById('totalAnimators').textContent = overview.total_animators || 0;
    document.getElementById('activeAnimators').textContent = overview.active_animators_today || 0;
    document.getElementById('totalVisits').textContent = (overview.total_visits_month || 0).toLocaleString();
    document.getElementById('totalRevenue').textContent = formatCurrency(overview.total_revenue_month || 0);
    document.getElementById('conversionRate').textContent = formatPercent(overview.avg_conversion_rate || 0);
    
    // Calculs d√©riv√©s
    const avgVisits = Math.round((overview.total_visits_month || 0) / (overview.total_animators || 1));
    document.getElementById('avgVisitsPerAnimator').textContent = avgVisits;
    
    // Growth indicators (mock - √† remplacer par donn√©es r√©elles)
    document.getElementById('animatorsGrowth').textContent = '+12%';
    document.getElementById('visitsGrowth').textContent = '+18%';
    document.getElementById('revenueGrowth').textContent = '+25%';
    document.getElementById('conversionGrowth').textContent = '+8%';
}

// ============================================================================
// INIT CHARTS
// ============================================================================
function initCharts() {
    // Chart: Revenue Forecast
    const ctxForecast = document.getElementById('revenueForecastChart').getContext('2d');
    charts.revenueForecast = new Chart(ctxForecast, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenus Projet√©s',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: (context) => formatCurrency(context.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => formatCurrency(value, true)
                    }
                }
            }
        }
    });

    // Chart: Conversion Funnel
    const ctxFunnel = document.getElementById('conversionFunnelChart').getContext('2d');
    charts.conversionFunnel = new Chart(ctxFunnel, {
        type: 'bar',
        data: {
            labels: ['Leads Cr√©√©s', 'Contact√©s', 'Qualifi√©s', 'Proposition', 'Gagn√©s'],
            datasets: [{
                label: 'Leads',
                data: [],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Chart: Regional Performance
    const ctxRegional = document.getElementById('regionalPerformanceChart').getContext('2d');
    charts.regionalPerformance = new Chart(ctxRegional, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Revenus',
                    data: [],
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    yAxisID: 'y'
                },
                {
                    label: 'Visites',
                    data: [],
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: {
                        callback: (value) => formatCurrency(value, true)
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// ============================================================================
// UPDATE CHARTS
// ============================================================================
function updateRevenueForecastChart(forecast) {
    const days = forecast.horizon_days || 30;
    const dailyRevenue = forecast.forecast.avg_daily_revenue || 0;
    
    // Generate forecast data
    const labels = [];
    const data = [];
    
    for (let i = 1; i <= days; i++) {
        labels.push(`J${i}`);
        data.push(dailyRevenue * i);
    }
    
    charts.revenueForecast.data.labels = labels;
    charts.revenueForecast.data.datasets[0].data = data;
    charts.revenueForecast.update();
}

function updateConversionFunnelChart(funnel) {
    charts.conversionFunnel.data.datasets[0].data = [
        funnel.leads_created || 0,
        funnel.leads_contacted || 0,
        funnel.leads_qualified || 0,
        funnel.leads_proposal || 0,
        funnel.leads_won || 0
    ];
    charts.conversionFunnel.update();
}

function updateRegionalPerformanceChart(regions) {
    const labels = regions.map(r => r.region);
    const revenues = regions.map(r => r.total_revenue || 0);
    const visits = regions.map(r => r.total_visits || 0);
    
    charts.regionalPerformance.data.labels = labels;
    charts.regionalPerformance.data.datasets[0].data = revenues;
    charts.regionalPerformance.data.datasets[1].data = visits;
    charts.regionalPerformance.update();
}

// ============================================================================
// UPDATE SECTIONS
// ============================================================================
function updateTopPerformers(regions) {
    const top5 = regions.slice(0, 5);
    const html = top5.map((region, index) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <div class="flex items-center gap-3">
                <span class="text-2xl">${['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'][index]}</span>
                <div>
                    <p class="font-semibold text-gray-800">${region.region}</p>
                    <p class="text-sm text-gray-500">${region.animators_count} animateurs</p>
                </div>
            </div>
            <div class="text-right">
                <p class="font-bold text-gray-800">${formatCurrency(region.total_revenue || 0, true)}</p>
                <p class="text-sm text-gray-500">${region.total_visits || 0} visites</p>
            </div>
        </div>
    `).join('');
    
    document.getElementById('topPerformers').innerHTML = html;
}

function updateStrategicAlerts(alerts) {
    if (!alerts || alerts.length === 0) {
        document.getElementById('strategicAlerts').innerHTML = `
            <div class="text-center py-8 text-gray-400">
                <i class="fas fa-check-circle text-4xl mb-2"></i>
                <p>Aucune alerte critique</p>
            </div>
        `;
        return;
    }
    
    const html = alerts.map(alert => {
        const severityColors = {
            critical: 'bg-red-100 text-red-800 border-red-300',
            warning: 'bg-yellow-100 text-yellow-800 border-yellow-300',
            info: 'bg-blue-100 text-blue-800 border-blue-300'
        };
        
        return `
            <div class="border-l-4 p-4 ${severityColors[alert.severity]} rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold mb-1">${alert.title}</h4>
                        <p class="text-sm">${alert.description}</p>
                    </div>
                    <button onclick="resolveAlert('${alert.id}')" class="text-sm underline hover:no-underline">
                        R√©soudre
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('strategicAlerts').innerHTML = html;
}

// ============================================================================
// ACTIONS
// ============================================================================
async function refreshData() {
    await loadDashboardData();
}

async function updateForecast(days) {
    const forecast = await axios.get(`${API_BASE_URL}/executive/revenue-forecast?horizon=${days}`);
    updateRevenueForecastChart(forecast.data);
}

async function resolveAlert(alertId) {
    // TODO: Implement alert resolution
    console.log('R√©solution alerte:', alertId);
}

// ============================================================================
// UTILITIES
// ============================================================================
function formatCurrency(value, short = false) {
    if (short && value >= 1000) {
        return (value / 1000).toFixed(1) + 'k MAD';
    }
    return value.toLocaleString('fr-FR') + ' MAD';
}

function formatPercent(value) {
    return (value * 100).toFixed(1) + '%';
}
</script>

</body>
</html>
