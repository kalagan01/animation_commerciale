<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organisations - NeoImpact Animation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/neoimpact-ui.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <!-- Logo NeoImpact -->
                <div class="neoimpact-logo" style="display: flex; align-items: center; gap: 12px; margin-right: 20px;">
                    <div class="logo-icon">
                        <svg width="40" height="40" viewBox="0 0 48 48" fill="none">
                            <path d="M24 4L4 14v20l20 10 20-10V14L24 4z" fill="#FFD600"/>
                            <path d="M24 14l-12 6v12l12 6 12-6V20l-12-6z" fill="#00A5A8"/>
                            <path d="M24 20v16l8-4V16l-8 4z" fill="#FFFFFF" opacity="0.5"/>
                        </svg>
                    </div>
                    <div class="logo-text" style="line-height: 1.2;">
                        <div class="logo-arabic" style="font-size: 14px; font-weight: 600; color: #00A5A8;">وفاسلف</div>
                        <div class="logo-latin" style="font-size: 10px; color: #6B6B6B; letter-spacing: 1px;">NeoImpact</div>
                    </div>
                </div>
<h1 class="text-xl font-bold text-gray-900">NeoImpact Animation</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Organisations</h2>
                <p class="text-gray-600 mt-1">Gérer les organisations et structures commerciales</p>
            </div>
            <button onclick="openCreateModal()" class="bg-[#00A5A8] hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Nouvelle Organisation
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Organisations</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-count">0</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <i class="fas fa-sitemap text-[#00A5A8]"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Actives</p>
                        <p class="text-2xl font-bold text-[#00A5A8]" id="active-count">0</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <i class="fas fa-check-circle text-[#00A5A8]"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Inactives</p>
                        <p class="text-2xl font-bold text-gray-600" id="inactive-count">0</p>
                    </div>
                    <div class="bg-gray-100 rounded-full p-3">
                        <i class="fas fa-times-circle text-gray-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Territoires liés</p>
                        <p class="text-2xl font-bold text-purple-600" id="territories-count">0</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-3">
                        <i class="fas fa-map-marked text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recherche</label>
                    <input type="text" id="search-input" placeholder="Nom ou code..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                    <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Tous</option>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <select id="type-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Tous</option>
                        <option value="direction">Direction</option>
                        <option value="region">Région</option>
                        <option value="district">District</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territoires</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="organisations-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Loading -->
                        <tr id="loading-row">
                            <td colspan="7" class="px-6 py-12 text-center">
                                <i class="fas fa-spinner fa-spin text-3xl text-[#00A5A8] mb-4"></i>
                                <p class="text-gray-600">Chargement des organisations...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between bg-white px-6 py-4 rounded-lg shadow mt-6">
            <div class="text-sm text-gray-700">
                Affichage <span id="showing-from">0</span> à <span id="showing-to">0</span> sur <span id="showing-total">0</span> résultats
            </div>
            <div class="flex space-x-2">
                <button id="prev-btn" onclick="previousPage()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                <button id="next-btn" onclick="nextPage()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900">Nouvelle Organisation</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="organisation-form" class="space-y-6">
                <input type="hidden" id="organisation-id">
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Code *</label>
                        <input type="text" id="code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                        <select id="type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Sélectionner...</option>
                            <option value="direction">Direction</option>
                            <option value="region">Région</option>
                            <option value="district">District</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                    <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Responsable</label>
                    <input type="text" id="manager" placeholder="Nom du responsable" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                    <select id="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-[#00A5A8] hover:bg-blue-700 text-white rounded-lg flex items-center">
                        <i class="fas fa-save mr-2"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // Configuration API - Support sandbox et localhost
        const API_BASE = window.location.hostname.includes('sandbox.novita.ai') 
            ? window.location.protocol + '//' + window.location.hostname.replace('8080-', '3000-')
            : 'http://localhost:3000';

        let currentPage = 1;
        let currentData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOrganisations();
            
            // Event listeners
            document.getElementById('search-input').addEventListener('input', debounce(loadOrganisations, 500));
            document.getElementById('status-filter').addEventListener('change', loadOrganisations);
            document.getElementById('type-filter').addEventListener('change', loadOrganisations);
            document.getElementById('organisation-form').addEventListener('submit', handleSubmit);
        });

        // Load organisations
        async function loadOrganisations() {
            try {
                const search = document.getElementById('search-input').value;
                const status = document.getElementById('status-filter').value;
                const type = document.getElementById('type-filter').value;

                let url = `${API_BASE}/api/v1/organisations?page=${currentPage}&limit=20`;
                if (status) url += `&status=${status}`;
                if (type) url += `&type=${type}`;
                if (search) url += `&search=${search}`;

                const response = await axios.get(url);
                currentData = response.data.data;

                renderTable(currentData);
                updatePagination(response.data.pagination);
                updateStats(currentData);
            } catch (error) {
                console.error('Erreur chargement:', error);
                showError('Erreur lors du chargement des organisations');
            }
        }

        // Render table
        function renderTable(data) {
            const tbody = document.getElementById('organisations-tbody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-sitemap text-4xl mb-4"></i>
                            <p>Aucune organisation trouvée</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(org => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${org.code}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${org.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getTypeBadgeClass(org.type)}">
                            ${getTypeLabel(org.type)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${org.manager || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${org.territories_count || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${org.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${org.status === 'active' ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editOrganisation('${org.id}')" class="text-[#00A5A8] hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteOrganisation('${org.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Modal functions
        function openCreateModal() {
            document.getElementById('modal-title').textContent = 'Nouvelle Organisation';
            document.getElementById('organisation-form').reset();
            document.getElementById('organisation-id').value = '';
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        async function editOrganisation(id) {
            try {
                const response = await axios.get(`${API_BASE}/api/v1/organisations/${id}`);
                const org = response.data.data;

                document.getElementById('modal-title').textContent = 'Modifier Organisation';
                document.getElementById('organisation-id').value = org.id;
                document.getElementById('code').value = org.code;
                document.getElementById('name').value = org.name;
                document.getElementById('type').value = org.type;
                document.getElementById('description').value = org.description || '';
                document.getElementById('manager').value = org.manager || '';
                document.getElementById('status').value = org.status;
                document.getElementById('modal').classList.remove('hidden');
            } catch (error) {
                showError('Erreur lors du chargement');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('organisation-id').value;
            const data = {
                code: document.getElementById('code').value,
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                description: document.getElementById('description').value,
                manager: document.getElementById('manager').value,
                status: document.getElementById('status').value
            };

            try {
                if (id) {
                    await axios.patch(`${API_BASE}/api/v1/organisations/${id}`, data);
                    showSuccess('Organisation mise à jour');
                } else {
                    await axios.post(`${API_BASE}/api/v1/organisations`, data);
                    showSuccess('Organisation créée');
                }
                closeModal();
                loadOrganisations();
            } catch (error) {
                showError('Erreur lors de l\'enregistrement');
            }
        }

        async function deleteOrganisation(id) {
            if (!confirm('Supprimer cette organisation ?')) return;

            try {
                await axios.delete(`${API_BASE}/api/v1/organisations/${id}`);
                showSuccess('Organisation supprimée');
                loadOrganisations();
            } catch (error) {
                showError('Erreur lors de la suppression');
            }
        }

        // Helpers
        function getTypeBadgeClass(type) {
            const classes = {
                direction: 'bg-purple-100 text-purple-800',
                region: 'bg-blue-100 text-blue-800',
                district: 'bg-green-100 text-green-800'
            };
            return classes[type] || 'bg-gray-100 text-gray-800';
        }

        function getTypeLabel(type) {
            const labels = {
                direction: 'Direction',
                region: 'Région',
                district: 'District'
            };
            return labels[type] || type;
        }

        function updateStats(data) {
            const total = data.length;
            const active = data.filter(o => o.status === 'active').length;
            const inactive = total - active;
            const territories = data.reduce((sum, o) => sum + (o.territories_count || 0), 0);

            document.getElementById('total-count').textContent = total;
            document.getElementById('active-count').textContent = active;
            document.getElementById('inactive-count').textContent = inactive;
            document.getElementById('territories-count').textContent = territories;
        }

        function updatePagination(pagination) {
            document.getElementById('showing-from').textContent = (currentPage - 1) * pagination.limit + 1;
            document.getElementById('showing-to').textContent = Math.min(currentPage * pagination.limit, pagination.total);
            document.getElementById('showing-total').textContent = pagination.total;

            document.getElementById('prev-btn').disabled = !pagination.has_prev;
            document.getElementById('next-btn').disabled = !pagination.has_next;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadOrganisations();
            }
        }

        function nextPage() {
            currentPage++;
            loadOrganisations();
        }

        function debounce(func, wait) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), wait);
            };
        }

        function showSuccess(message) {
            alert(message);
        }

        function showError(message) {
            alert('Erreur: ' + message);
        }
    </script>
</body>
</html>
